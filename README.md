# Проектирование высоконагруженного сервиса обмена сообщениями

# 1. Тема и целевая аудитория

## Тема

Мессенджер Telegram - кроссплатформенная система мгновенного обмена сообщениями, позволяющая обмениваться текстовыми, голосовыми и видеосообщениями, стикерами и фотографиями, файлами многих форматов.

## MVP
1. Авторизация, регистрация по номеру телефона
2. Отправка текстовых сообщений
3. Отправка голосовых сообщений
4. Отправка файлов
5. Реакции на сообщения
6. Список чатов
7. История сообщений
8. Каналы
9. Метрики для каналов(активность, просмотры, рост подписчиков и т.д.)
10. Поиск людей по номеру телефона

## Продуктовые особенности
* Платная подписка, дающая доступ к распознаванию голосовых сообщений, анимированным стикерам, кастомным эмодзи и эмодзи-статусам

## ЦА
Ниже представлена статистика исследования аудитории Telegram. В опросе приняли участие жители из более чем 70 стран.
Возраст целевой аудитории варьируется в диапазоне от 18 до 64 лет [[1]](https://tgstat.ru/research-2023)
Возрастная группа | Процентное соотношение
------------ | -------------
до 17 лет | 6,4%
18-24 года| 18,8% 
25-34 года| 29,4% 
35-44 года| 23,8% 
45-64 года| 21,6% 

Размер целевой аудитории: 800 млн. пользователей в месяц, 55.2 млн. пользователей в день на момент конца 2023г. [[2]](https://www.demandsage.com/telegram-statistics/)

Общемировая география пользователей на момент 2024г [[3]](https://www.businessofapps.com/data/telegram-statistics/):  
Регион           | Процентное соотношение
---------------- | -------------
Азия             | 38%
Европа           | 27% 
Латинская Америка| 21% 
страны MENA      | 8% 

География русскоязычных пользователей:
Страна       | Процентное соотношение
-------------| -------------
Россия       | 60%
Беларусь     | 17% 
Украина      | 13% 

Гендерное распределение аудитории Telegram:
Пол          | Процентное соотношение
-------------| -------------
Мужской      | 58%
Женский      | 42% 

# 2 Расчёт нагрузки

Ежемесячная аудитория Telegram: 800 млн. пользователей.

Ежедневная аудитория Telegram: 55.2 млн. пользователей.

Согласно исследованию [[4]](https://www.demandsage.com/telegram-statistics/):

Количество отправленных сообщений в день: 15 миллиардов

Количество регистраций в день: 8.33 млн.

Средняя длительность сессии: 6 минут.

Исходя из исследования [[5]](https://www.tadviser.ru/index.php/Статья:Мессенджеры_(Instant_Messenger,_IM)#:~:text=Как%20выяснилось%2C%20в%20среднем%20пользователь,идут%20Viber%2C%20Telegram%20и%20Skype.):

Количество заходов в день: 24 

### Хранилище данных для пользователя
Посчитаем количество сообщений в день на одного пользователя : 15 млрд. / 55.2 млн. ~ 272 [сообщ/чел]

Предпологаем, что:
* Из 272 сообщений 10 будут голосовыми и 40 будут фотографиями(за сообщения также приняты посты в каналах).
* Средняя длина одного сообщения равна 60 символам в кодировки UTF-8, где 1 символ равен 1 байту. [[6]](https://cyberleninka.ru/article/n/poliformatnyy-messendzher-kak-zhanr-2-0-na-primere-messendzhera-mgnovennyh-soobscheniy-telegram/viewer)
* Средняя длина записи одного голосового сообщения равна 30 секундам, битрейт равен 128 kbps, тогда размер будет равен 480 кБ.
* Средний размер одной фотографии из сообщений равен 256 кБ.
* Сообщения хранятся 3 года.
* Среднее количество чатов у одного пользователя равно 15
* Количество единовременно подгружаемых сообщений в диалоге равно 10
* Среднее количество людей, с которыми пользователь общается в день равно 8
* Размер сообщения в превью чата равен 30 символам
* Название чата равно 20 символам

Чат в списке чатов состоит из аватарки чата(256 кБ), последнего сообщения (превью), названия чата.
Тогда размер одного чата равен: 100 кБ + 30 * 0.03(кБ) + 20 * 0.02(кБ) = 461.2 кБ

Тогда общий объем _сообщений_, отправляемых в день, на одного пользователя равен: 222 * 0.06 (кБ) + 10 * 480 (кБ) + 40 * 256 (кБ) = 15053 кБ

Средний размер _профиля_ пользователя составляет 256 кБ (аватарка + данные о пользователе(номер телефона, уникальный идентификатор, имя)).

Итого: суммарный объем данных на одного пользователя за 3 года: 15053(кБ) * 365 * 3 + 256 = 15.72 ГБ

### Динамический рост

Так как в день отправляется около 15 млрд. сообщений, то можно вычислить, какой объем данных будет занят пользователями за, например, 1 год.

Расчет для фотографий и голосовых сообщений: ((10 * 480 (кБ) +  40 * 256 (кБ)) * 55 200 000 * 365)/1024^4 = 275.6 ПБ / год
Расчет для текстовых сообщений: (222 * 0.06 (кБ) * 55 200 000 * 365)/1024^4 = 0.24 ПБ/год

### Сетевой трафик
При расчете сетевого трафика не будем учитывать запросы, связанные с регистрацией пользователей, так как они не создают ощутимую нагрузку на наш сервис.
Основная нагрузка приходится на отправку сообщений, загрузку списка чатов и историю сообщений.

### Предварительные расчеты:
Посчитаем объем трафика для списка чатов на одного человека с учетом количества заходов в сутки: 24 * 15 * 101.3 кБ = 36 468 кБ
Посчитаем объем трафика для истории сообщений на одного человека с учетом  количества единовременно подгружаемых сообщений в диалоге(канале), среднего количества людей, с которыми общается пользователь в день(каналов, на которые пользователь подписан): 8 * 15 * 0.06 (кБ) = 7.2 кБ

Рассмотрим трафик по видам активностей:


Тип          | Отправка (дневная аудитория 55 млн)   | Отправка Гб/сек |
-------------| -------------| ---------|
Текстовое     | 262 * 55 млн. * 0. 06 кБ             | 0.008            |
   Голосовое     | 5 * 55 млн. * 480 кБ                 | 2.92              | 
   Фотография    | 5 * 55 млн. * 256 кБ                | 6.23              |
   Список чатов  | 36 468 кБ * 55 млн.                  | 22.22|
   История сообщений  | 4.8 кБ * 55 млн.                | 0.004             |
   Итого  |                                             | 31.386           |

### RPS
 
* Отправка сообщения: 55.2 млн * 222 / 86400 = 141 833 RPS
* Регистрация: 8.33 млн / 86400 = 96 RPS
* Авторизация: 55.2 млн. / 86400 = 638.8 ~ 639 RPS
* Получение списка чатов: 55.2 млн. * 24 / 86400 = 15 333 RPS
* Получение истории сообщений: 55.2 млн. * 8 / 86400 = 5 111 RPS

Действие                            | RPS
------------------------------------| ---
Отправка сообщения                  | 141 833
Регистрация                         | 96
Авторизация                         | 639
Получение списка чатов              | 15 333
История сообщений                   | 5 111
**Итого**                           | 163 012

Согласно графику дневной активности в телеграм[[7]](https://stock-bt.ru/wp-content/uploads/7/8/d/78d07edab4abb2eb268bc027bf59142d.png)
пиковое значение активности пользователей(соответственно RPS тоже) приблизительно в 1.66 раза выше среднего значения. Возьмем коэффициент запаса равный 2
Соответственно:

   Тип          | Пиковое значение   | Пиковое значение с коэффициентом запаса 2  |
-------------| -------------| ---------|
RPS     | 270 600             | 540 936            |
   Сетевой трафик(Гб/c)     | 52                 | 104              | 

## Список источников

1. https://tgstat.ru/research-2023

2. https://www.demandsage.com/telegram-statistics/

3. https://www.businessofapps.com/data/telegram-statistics/

